# ***********************
# plumber.R

library(recommenderlab)
library(dplyr)
library(readr)
library(feather)

# Debug
print(local_path)

read_reset_password <- function(){
  passw <- read_file(paste0(local_path, "/password.txt"))

  substr(passw, 1, nchar(passw)-1)
}

#***********************
# storing and reading data ----
get_article_data <- function(){
  read_rds(paste0(local_path,"/articles.rds"))
}

store_user_ratings <- function(m){
  m %>% as("data.frame") %>% write_feather(paste0(local_path,"/ratings.feather"))
}

read_user_ratings <- function(){
  if(!file.exists(paste0(local_path,"/ratings.feather"))){
    m <- new_rating_matrix()
  } else {
    m <- read_feather(paste0(local_path,"/ratings.feather")) %>% as.data.frame() %>% as("realRatingMatrix")
  }
  m
}

#***********************
# initialization ----
possible_recommenders <- c("POPULAR", "IBCF", "UBCF", "SVD", "RANDOM")
user_data <- tibble(userid = 0L, recommender = possible_recommenders[1])
articles <- get_article_data()



# ***********************
# helping functions -----


# create new rempty rating matrix
new_rating_matrix <- function(){
  entry <- data.frame(user = character(0L), item = character(0L), rating = numeric(0L), stringsAsFactors = F)
  entry %>% as("realRatingMatrix")
}


# add a rating to an existing rating matrix
add_rating <- function(m, user_id, item_id, rating){
  
  print(paste("add_rating - user_id:", user_id, ", item_id", item_id, ", rating", rating))
  #user_id = "test"
  #item_id = "testi"
  #rating = 5
  df <- m %>%  as("data.frame") 
  if(length(df) == 0){
    df <- data.frame(user = character(0L), item = character(0L), rating = numeric(0L), stringsAsFactors = F)
  }
  df$user <- as.character(df$user)
  df$item <- as.character(df$item)
  entry <- data.frame(user = user_id, item = item_id, rating = rating, stringsAsFactors = F)
  df %>% bind_rows(entry) %>% as("realRatingMatrix")
}




#***********************
#***********************
#
# API FUNCTIONS ----
#
#***********************

#' Register a User at the recommender system
#' @param participantID ID generated by Qualtrics
#' @param age Age of the participant
#' @param gender Gender of the participant
#' @get /register
#' @json
register <- function(participantID, age, gender){
  # Create a new user object
  # Add user to the recommemnder
  
  print(paste("register - participantID: ", participantID, ", age: ", age, ", gender:", gender))
  
  "success"
}

#' Gets a recommendation for the specified recsys
#' @param participantID ID generated by Qualtrics
#' @param recsys the name for the recommender system 
#' @param iteration the number of recommended iterations
#' @get /getrecommendation
#' @json
getrecommendation <- function(participantID, recsys = "RANDOM", iteration = 1){
  
  print(paste("getrecommendation - participant_ID:", participantID, ", recsys:", recsys, ", iteration", iteration))
  #debug
  #participantID <- "U11"
  #recsys <- "SVD"
  m <- read_user_ratings()
  
  if(recsys == "RANDOM"){
    ml <- m %>% as("list")
    possible_ids <- as.data.frame(ml$DEMO %>% names())
    names(possible_ids) <- c("id")
    value <- sample_n(possible_ids, 1) %>% pull(id) %>% as.integer()
    return(value)
  }
  
  # count of users.. only run SVD if users > k
  REAL_SVD_param <- list(
    k = 10,                     ## rank of approximation
    maxiter    = 100,           ## max. number of SVD iterations
    normalize  = "center"      ## rows
  )

  if(recsys == "SVD"){
    if(dim(m)[1] > REAL_SVD_param[1]){
      rec <- Recommender(m, method = recsys, parameter=REAL_SVD_param)
      print(paste("There are enough users. Using SVD.")) }
    else {
      rec <- Recommender(m, "RANDOM")
      print(paste("Number of users is too low. Using RANDOM instead of SVD.")) }
  }
  else {
    rec <- Recommender(m, method = recsys) #, parameter=REAL_SVD_param)
  }
  
  if(participantID %in% as.list(rownames(m))){
    recom <- predict(rec, m[participantID,], n=1)
  } else {
    rec <- Recommender(m, method = "RERECOMMEND")
    recom <- predict(rec, m["DEMO",], n=1)
  }
  recs <- as(recom, "list")
  article_id <- recs[[1]] %>% as.numeric()
  
  print(paste("getrecommendation(return) - articleID:", article_id))
  #get first recommendation
  articles %>% filter(ID_Article %in% article_id)
}

#' Sends the rating for a given item by a user
#' @param participantID ID generated by Qualtrics
#' @param itemID ID of the recommended item
#' @param rating how was the item rated
#' @get /sendrecommendation
#' @json
sendrecommendation <- function(participantID, itemID, rating){
  #itemID <- "7361"
  #rating <- "5"
  #participantID = "12"
  print(paste("sendrecommendation - participantID: ", participantID, ", itemID", itemID, ", rating:", rating))
  m <- read_user_ratings()
  m <- m %>% add_rating(participantID, itemID, as.numeric(rating))
  store_user_ratings(m)
  
  #Add rating to the recommender system for the given user
  #Store changes in the db
  #update recommender 
  "success"
}


#' Plot out data from the iris dataset
#' @param spec If provided, filter the data to only this species (e.g. 'setosa')
#' @get /plot
#' @png
plot <- function(spec){
  m <- read_user_ratings()
  r_m <- normalize(m)
  getRatingMatrix(r_m)
  p <- image(r_m, main = "Normalized Ratings")
  print(p)
}

#' Get the text of an item
#' @get /getitem
#'
#' @param itemID ID of the recommended item
#' @json
getitem <- function(itemID){
  articles %>% filter(ID_Article %in% itemID)
}


#' Test whether the service is alive
#' @get /alive
#' @json
alive <- function(){
  "Server is alive."
}


#' Test whether the service is alive
#' @get /reset
#' @param password 
#' @json
reset <- function(password){
  
  if(password==read_reset_password()){
    m <- read_feather(paste0(local_path,"/ratings_DEMO.feather")) %>% as.data.frame() %>% as("realRatingMatrix")
    m %>% as("data.frame") %>% filter(user == "DEMO") %>% store_user_ratings()
    return("Reset")
  }
  return("")
}


